#!/bin/sh

LINT=$(which swiftlint)

if [[ -e "${LINT}" ]]; then
    echo "ğŸš€  SwiftLint Start..."
    echo "ğŸ”  lint Application Path: $(pwd)"
else
    echo "SwiftLint is not exist, please check. ğŸŒ https://github.com/realm/SwiftLint"
    exit 1
fi

normalfiles=$(git diff --stat --cached)
targets=$(git diff --stat --cached --diff-filter=d --name-only $(git for-each-ref --format='%(upstream:short)' $(git symbolic-ref -q HEAD)) | grep -F ".swift")

if [ -n "$normalfiles" -a -z "$targets" ]; then
  printf "âœ¨ Good JobğŸ‘ ğŸ‘ ğŸ‘\n"
  exit 0

elif [ -z "${normalfiles}" ]; then
  printf "ğŸ·ï¸ There's no Swift file on Staging Area"
  printf "\n âœ” Please proceed with git add first:)"
  exit 1

elif [ -z "$targets" ]; then
  printf "ğŸ·ï¸ There's no Swift file on Staging Area"
  printf "\n âœ” Please proceed with git add first:)"
  exit 1
fi

# lint rule ì •ì˜ íŒŒì¼
RESULT=$($LINT lint --quiet --config .swiftlint.yml --strict)

if [ "$RESULT" == '' ]; then
    printf "âœ¨ Completed applying SwiftLint!! Good Job:)\n"
else
    echo ""
    printf "âœ” SwiftLint Failed. Please check the details below :\n"
    while read -r line; do
        FILEPATH=$(echo $line | cut -d : -f 1)
        L=$(echo $line | cut -d : -f 2)
        C=$(echo $line | cut -d : -f 3)
        TYPE=$(echo $line | cut -d : -f 4 | cut -c 2-)
        MESSAGE=$(echo $line | cut -d : -f 5 | cut -c 2-)
        DESCRIPTION=$(echo $line | cut -d : -f 6 | cut -c 2-)
        if [ $TYPE == 'warning' ]; then
            printf "\n ğŸš§  $TYPE\n"
            # warning íƒ€ì…ì€ ì˜¤ë¥˜ë©”ì‹œì§€ë§Œ í‘œì‹œí•˜ê³  ì»¤ë°‹ì„ í—ˆìš©í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”.
            # printf "    $FILEPATH:$L:$C\n"
            # printf "    ğŸ“Œ  $MESSAGE: - $DESCRIPTION\n"
            # exit 0
        elif [ $TYPE == 'error' ]; then
            printf "\n ğŸš¨  $TYPE\n"
        fi
        printf "    âœ” $FILEPATH:$L:$C\n"
        printf "    ğŸ“Œ $MESSAGE: - $DESCRIPTION\n"
    done <<< "$RESULT"

    printf "\n ğŸš‘  Commit failed!! Please change the code according to SwiftLint rules.:)\n"
    exit 1
fi
